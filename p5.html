<html>
	<head>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<script language="javascript" type="text/javascript" src="js/shake.js"></script>
		<script language="javascript" type="text/javascript" src="js/p5.min.js"></script>
		<script type="text/javascript">
			var characterWidth = 200;
			var characterHeight = 400;

			var backgroundColor = 0;
			var characterColor = 200;
			var strokeSize = 5;

			var joints = [];
			for (var a = 0; a < 23; a++) {
				joints[a] = 0;
			}

			var drawing = [];
		
			var socket = io.connect();
			
			socket.on('connect', function() {
				console.log("Connected");
			});

			// Receive mouse
			socket.on('mouse', function (data) {
				console.log(data.color);
				drawIt(data.startX, data.startY, data.endX, data.endY, data.color);
				//drawIt(data.startX - joints[3].x, data.startY - joints[3].y, data.endX - joints[3].x, data.endY - joints[3].y);
			});
			
			var sendmouse = function(startX, startY, endX, endY, color) {
				socket.emit('mouse', {startX: startX, startY: startY, endX: endX, endY: endY, colorR: red(color), colorG: green(color), colorB: blue(color)});
			};
			
			socket.on('clear', function (data) {
				clearDrawing();
			});
			
			socket.on('kinect', function (data) {
				joints[data.position] = {x: (data.x)*characterWidth/2+canvas.width/2,
									y: (data.y*-1)*characterHeight/2+canvas.height/2+50};
			});

			var mousedown = false;
			var drawingColor;

			function setup() {
				var can = createCanvas(windowWidth, windowHeight-100);
				can.parent("canvas_div");

				drawingColor = color(random(128,255), random(128,255), random(128,255));
			}

			function draw() {
				background(backgroundColor);
				fill(backgroundColor);
				stroke(characterColor);
				strokeWeight(strokeSize);
				ellipseMode(CENTER);

				if (joints[2] != null) {
					if (joints[3] != null) {
						line(joints[2].x, joints[2].y, joints[3].x, joints[3].y);

						ellipse(
							(joints[2].x + joints[3].x)/2, 
							(joints[2].y + joints[3].y)/2 - (joints[2].y - joints[3].y)*2, 
							(joints[2].y - joints[3].y)*4, 
							(joints[2].y - joints[3].y)*4
						);
					}

					if (joints[20] != null) {
						line(joints[2].x, joints[2].y, joints[20].x, joints[20].y);
						
						if (joints[1] != null) {
							line(joints[20].x, joints[20].y, joints[1].x, joints[1].y);
							if (joints[17] != null) {
								line(joints[1].x, joints[1].y, joints[17].x, joints[17].y);
								if (joints[19] != null) {
									line(joints[17].x, joints[17].y, joints[19].x, joints[19].y);
								}
							}

							if (joints[13] != null) {
								line(joints[1].x, joints[1].y, joints[13].x, joints[13].y);
								if (joints[15] != null) {
									line(joints[13].x, joints[13].y, joints[15].x, joints[15].y);
								}
							}
						}

						if (joints[9] != null) {
							line(joints[20].x, joints[20].y, joints[9].x, joints[9].y);
							if (joints[23] != null) {
								line(joints[9].x, joints[9].y, joints[23].x, joints[23].y);
							}
						}

						if (joints[5] != null) {
							line(joints[20].x, joints[20].y, joints[5].x, joints[5].y);
							if (joints[21] != null) {
								line(joints[5].x, joints[5].y, joints[21].x, joints[21].y);
							}
						}
					}
				}

				for (var d = 0; d < drawing.length; d++) {
					stroke(drawing[d].color);
					line(joints[3].x + drawing[d].startX, 
						joints[3].y + drawing[d].startY, 
						joints[3].x + drawing[d].endX,
						joints[3].y + drawing[d].endY);
				}
			}

			function touchStarted() {
				mousedown = true;
			}

			function touchMoved() {
				if (touches.length == 1) {
					mousedown = true;
                    sendmouse(ptouchX - joints[3].x, ptouchY - joints[3].y, touchX - joints[3].x, touchY - joints[3].y, drawingColor);

                    drawIt(ptouchX - joints[3].x, ptouchY - joints[3].y, touchX - joints[3].x, touchY - joints[3].y, drawingColor);

					return false;
				}
			}

			function touchEnded() {
				mousedown = false;
			}

			function mouseDragged() {	 
				sendmouse(pmouseX - joints[3].x, pmouseY - joints[3].y, mouseX - joints[3].x, mouseY - joints[3].y, drawingColor);
				drawIt(pmouseX - joints[3].x, pmouseY - joints[3].y, mouseX - joints[3].x, mouseY - joints[3].y, drawingColor);
			}
				
			var drawIt = function(startX, startY, endX, endY, color) {
				drawing.push({startX: startX, startY: startY, endX: endX, endY: endY, color: color});
				//console.log(drawing.length);
			};

			var clearDrawing = function() {
				drawing.length = 0;
			};

			var clearButton;
			var init = function(e) {
				clearButton = document.getElementById('clear');
				clearButton.addEventListener('click',clearDrawing);

				document.getElementById('red').addEventListener('click',function() {
					drawingColor = color('red');
				});

				document.getElementById('green').addEventListener('click',function() {
					drawingColor = color('green');
				});

				document.getElementById('blue').addEventListener('click',function() {
					drawingColor = color('blue');
				});

				document.getElementById('erase').addEventListener('click',function() {
					drawingColor = color(backgroundColor);
				});

				document.getElementById('save').addEventListener('click', function() {
					saveDrawing();
				});
			};
			window.addEventListener('load',init);

			var saveDrawing = function() {
				saveCanvas(new Date().getTime(),'jpg');
			};

			////////////////
			//https://github.com/alexgibson/shake.js/
			////////////////
			var myShakeEvent = new Shake({
    			threshold: 15, // optional shake strength threshold
    			timeout: 1000 // optional, determines the frequency of event generation
			});
			myShakeEvent.start();

			window.addEventListener('shake', shakeEventDidOccur, false);

			function shakeEventDidOccur () {
				clearDrawing();
			}

		</script>
		<style>
			body {
				background-color: #000000;
			}

			.red {
				background-color: red;
			}

			.blue {
				background-color: blue;
			}

			.green {
				background-color: green;
			}
		</style>		
	</head>
	<body>
		<div id="content_wrapper">
			<div id="canvas_div"></div>
			<button id="clear">Clear</button>
			<button id="red" class="red">Red</button>
			<button id="green" class="green">Green</button>
			<button id="blue" class="blue">Blue</button>
			<button id="erase" class="erase">Erase</button>
			<button id="save" class="save">Save</button>
		</div>
	</body>
</html>
