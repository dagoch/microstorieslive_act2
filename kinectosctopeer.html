<html>
<head>
  		<script src="js/peer.min.js"></script>
  <script type="text/javascript">
  ////  NOTE: ORDER
  // start BodyBasics to OSC firts
  // start server.js second
  // start this kinectosctopeer third
  // open or reload client.html
  
  var udp =require('udp');
  var osc = require('osc-min');
  util = require('util');

      // use socket io to connect to server so can send peer info to client page
  var io = require('socket.io-client');

  var socketConnected = false;

  var mypeerid = null;
  var peer = null;
  var connection = null;
var peer_ids = [];

  var init = function() {
    //peer = new Peer({key: 'uohu08l7r6swcdi'});
    //peer = new Peer({host: '104.131.82.13', port: 9000, path: '/'});
    //peer = new Peer({host: 'localhost', port: 9000, path: '/'});
				peer = new Peer({key: 'uohu08l7r6swcdi'});

    peer.on('open', function(id) {
      console.log('My peer ID is: ' + id);
      mypeerid = id;
    });

    peer.on('connection', function(conn) {
      connection = conn;
      connection.on('open', function() {
        document.getElementById('chatlog').innerHTML += "Connection Established";
      });
      connection.on('data', function(data) {
        document.getElementById('chatlog').innerHTML += data;
      });
    });

    // use socket io to connect to server so can send peer info to client page

    socket = io.connect('http://localhost:8080');
    //socket = io.connect('http://128.122.151.90:8080');
    socket.on('connect', function () {
     socketConnected = true;
     console.log("socket connected to server");
      if (mypeerid != null) {
              socket.emit('kinectPeerId',mypeerid);
     }
  });
     socket.on('getKinectPeerId', function(data) {
       console.log("received getKinectPeerId sending : "+mypeerid);
       socket.emit('kinectPeerId',mypeerid);

     });
     socket.on('clientPeerId', function(data) {  // receiving peer_id from index.html (client)
       console.log("Received client peer id: "+data);
       peer_ids.push(data);
       connection = peer.connect(data); // get a webrtc DataConnection
       connection.on('open', function(data) {
         document.getElementById('chatlog').innerHTML += " CLIENT Connection Established";
         console.log("OPen data connection with client");
       });

       connection.on('data', function(data) {
         document.getElementById('chatlog').innerHTML += " From client:" +data;
       });
     });
    //socket.emit('text', "hi");


  };

var sendKinectToPeer = function(data) {
  connection.send(data);

};


  var sendmessage = function() {
    connection.send(document.getElementById('chat').value);
    document.getElementById('chat').value = "";
  };

  var placecall = function() {
    connection = peer.connect(document.getElementById('other_peer_id').value);
    connection.on('open', function(data) {
      document.getElementById('chatlog').innerHTML += "Connection Established";
    });

    connection.on('data', function(data) {
      document.getElementById('chatlog').innerHTML += data;
    });
  };

  // start listening to udp port
  var c = 0;

  sock = udp.createSocket("udp4", function(msg, rinfo) {
    var error;
    try {
   var oscObj = osc.fromBuffer(msg);
   if (socketConnected) {
   console.log("got udp msg on sock");
  //  console.log(util.inspect(oscObj, {depth: 10}));
    if (oscObj.elements[0].elements[0].address == "/bodyJoint" && c%4==0) {
  //    console.log(JSON.stringify(oscObj)+",");
      var kinectdat = {position: oscObj.elements[0].elements[0].args[1].value,
        x: oscObj.elements[0].elements[0].args[2].value,
        y: oscObj.elements[0].elements[0].args[3].value,
        z: oscObj.elements[0].elements[0].args[4].value};
      console.log(c+": sending kinect data: "+util.inspect(kinectdat,{depth:10}));
     sendKinectToPeer(kinectdat);

     //socket.emit('kinect', oscObj);
     //console.log("sent osc packet");
    }
    //console.log("sent osc packet");
    c++;
   }
    //   console.log(util.inspect(osc.fromBuffer(msg),{depth: 10}));
   return;
    } catch (_error) {
      error = _error;
      return console.log("invalid OSC packet");
    }
  });
  sock.bind(8000);

  </script>
</head>
<body onload="init()">
<h1>Hello</h1>
<script>
var os = require('os');
document.write('You are running on ', os.platform());


console.log("Starting Up");
</script>


  <input type="text" id="other_peer_id" value="PeerID to Call">
  <input type="button" value="Call" onclick="placecall()"><br />
  <input type="text" id="chat">
  <input type="button" value="Send" onclick="sendmessage()"><br />
  <div id="chatlog"></div>
</body>
</html>
